%--------------------------------------------------------------------------
%   初始化
%--------------------------------------------------------------------------
clear;clc;

%--------------------------------------------------------------------------
%   MUSIC谱估计
%--------------------------------------------------------------------------

%--------------------------------------------------------------------------
%   参数设置
%--------------------------------------------------------------------------
derad = pi/180;
N = 8;                                                                      %阵元个数
M = 3;                                                                      %信源个数
theta = [-30 0 50];                                                         %信号来向
snr = 10;                                                                   %信噪比
K = 1024;                                                                   %快拍数

%--------------------------------------------------------------------------
%   生成3个来向的导向矢量
%--------------------------------------------------------------------------
dd = 0.5;                                                                   %阵元间距d = lambda/2
d = 0:dd:(N-1)*dd;                                                          %构建阵列坐标
A = exp(1j.*2*pi*d.'*sin(theta*derad));                                     %构建阵列流形

%--------------------------------------------------------------------------
%   发射三组随机信号，长度1024
%   并按照导向矢量模拟信号的回波相位
%--------------------------------------------------------------------------
S = randn(M,K) + 1j.*randn(M,K);                                            %构建不相关的信号特征
X = A*S;                                                                    %对信号来向进行仿真
X1 = awgn(X,snr,'measured');

%--------------------------------------------------------------------------
%   构建信号的协方差矩阵
%--------------------------------------------------------------------------
Rxx = X1*X1'/K;
[EV,D] = eig(Rxx);                                                          %拿到特征值+特征向量
EVA = diag(D)';

figure(1)
bar3(D);title('协方差矩阵的特征值')

figure(2)
for idx = 1:361
    angle(idx) = (idx-181)/2;
    phim = derad*angle(idx);
    a =exp(1j.*2*pi*d*sin(phim)).';
    En = EV(:,1:end-M);                                                     %用前面的几个小特征值的特征向量
    SP(idx) = (a'*En*En'*a); 
    
%     SP_abs = abs(SP);
    SP_abs = 1./abs(SP);
    SP_db = pow2db(SP_abs);
    plot(angle(1:idx),SP_db(1:idx));
    xlabel('入射角/(degree)');ylabel('空间谱/(dB)');
    grid on
    drawnow
end


